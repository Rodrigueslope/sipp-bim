<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIPP BIM — Simulador (One-Page) V9</title>
  <style>
    :root{
      --card:#fff; --ink:#0f172a; --muted:#cbd5e1;
      --rbim:#0FB268;
      --line:#e5e7eb;
      --radius:14px; --shadow:0 8px 28px rgba(0,0,0,.08);
      --emerald-accent: rgba(15,178,104,0.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0a3a28 0%,#0f5c3e 40%,#0a3a28 100%);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:24px auto 48px;padding:0 16px}
    header{margin-bottom:16px;display:flex;flex-direction:column;gap:14px;align-items:center}
    header .brand{display:flex;align-items:center;gap:14px}
    header img.logo{max-height:70px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    h1{margin:0 0 6px;font-size:22px;color:#fff}
    .sub{color:rgba(255,255,255,.88);font-size:13px;text-shadow:0 1px 0 rgba(0,0,0,.25)}
    .grid{ display:grid; gap:16px; grid-template-columns: 1.3fr .7fr; }
    @media (max-width:980px){ .grid{grid-template-columns: 1fr} }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .card .hd{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); }
    .card .hd h2{margin:0;font-size:20px}
    .card .hd .toggle{ border:0;background:transparent;color:var(--rbim);cursor:pointer;font-weight:700; }
    .card .bd{padding:20px; display:block}
    .card.collapsed .bd{display:none}
    .locked{opacity:.55; pointer-events:none}

    /* Right-side cards: branco com leve acento RBIM */
    aside .card.right{ background:#fff; border-color: var(--emerald-accent); }
    aside .card.right .hd{ border-bottom-color: var(--emerald-accent); }

    .form-grid{display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr));}
    @media (max-width:680px){ .form-grid{grid-template-columns: 1fr} }
    label{font-size:13px;color:#475569;display:block;margin-bottom:6px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font:inherit;
    }
    .hint{font-size:12px;color:#64748b}
    .note{display:flex;gap:8px;align-items:flex-start;background:#ecfdf5;border:1px solid rgba(15,178,104,.35);padding:10px 12px;border-radius:10px;font-size:13px;color:#065f46}
    .escopo-note{display:none; margin-top:10px; background:rgba(15,178,104,0.12); border:1px dashed rgba(15,178,104,.35); padding:10px 12px; border-radius:10px; color:#065f46; font-size:13px}

    aside{position:sticky; top:16px; height:fit-content; display:flex; flex-direction:column; gap:16px}
    .summary li{display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px dashed var(--line)}
    .summary li:last-child{border-bottom:0}
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; }
    .btn.primary{background:var(--rbim); color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;cursor:pointer;user-select:none;background:#fff}
    .pill.selected{border-color:var(--rbim);color:var(--rbim);background:#ecfdf5}

    .result-details{margin-top:12px;border-top:1px dashed var(--line);padding-top:12px;display:none}
    .range-box{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin-bottom:8px}
    .range-box .k{color:#475569;font-size:12px}
    .range-box .v{font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace; font-size:12.5px; background:#0b1424; color:#d1e2ff; padding:10px 12px;border-radius:10px; overflow:auto}
    ol.steps{margin:8px 0 0 16px; padding:0}
    ol.steps li{margin:6px 0}
    ul.obs{margin:8px 0 0 18px;padding:0}
    ul.obs li{margin:4px 0;color:#0f172a}
    .hide{display:none}

    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
  <!-- Supabase Auth Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>document.documentElement.style.visibility='hidden';</script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="sipp.png" alt="RBIM" />
      </div>
      <button id="logoutBtn" style="
  position:absolute;
  top:30px;
  right:40px;
  background:#0FB268;
  color:#fff;
  border:none;
  padding:8px 18px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(0,0,0,.2);
">
  Sair
</button>
      <h1>Simulador de Preços de Projetos e Serviços BIM — SIPP BIM</h1>
      <div class="sub">Preencha, clique em “Simular Custo” e veja o detalhamento com transparência.</div>
    </header>

    <div class="grid">
      <main class="stack" style="display:flex;flex-direction:column;gap:18px">

        <section class="card" data-section="dados">
          <div class="hd">
            <h2>1. Dados do Projeto ou Serviço</h2>
            <button class="toggle" data-toggle>Recolher</button>
          </div>
          <div class="bd">
            <div class="form-grid">
              <div>
                <label for="tipo">Tipo do Projeto/Serviço</label>
                <select id="tipo">
                  <option>Arquitetônico</option><option>Estrutural</option><option>Instalações</option><option>Consultoria</option>
                </select>
              </div>
              <div>
                <label for="area">Área do Projeto (m²)</label>
                <input id="area" type="number" min="0" step="1" placeholder="ex: 1000"/>
              </div>
              <div>
                <label for="local">Localidade (UF/Município)</label>
                <input id="local" type="text" placeholder="ex: SP, RJ, AM"/>
              </div>
              <div>
                <label for="complex">Complexidade do Projeto</label>
                <select id="complex">
                  <option value="baixa">Baixa</option>
                  <option value="media" selected>Média</option>
                  <option value="alta">Alta</option>
                </select>
              </div>
              <div>
                <label for="lod">Nível de Desenvolvimento BIM (LOD)</label>
                <select id="lod">
                  <option>LOD 200</option><option selected>LOD 300</option><option>LOD 350</option><option>LOD 400</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <section class="card" data-section="tipo">
          <div class="hd">
            <h2>2. Defina Tipo de Cálculo</h2>
            <button class="toggle" data-toggle>Recolher</button>
          </div>
          <div class="bd">
            <div class="note" id="m2_note" style="display:none;">
              <span>ℹ️</span>
              <div><strong>Atenção:</strong> escolha no item 4 a base Sinduscon/Região para usar o cálculo por m².</div>
            </div>
            <div style="margin-top:12px;display:grid;gap:10px">
              <label class="inline"><input type="radio" name="calc" value="m2" checked> Valor por metro quadrado (R$/m²)</label>
              <label class="inline"><input type="radio" name="calc" value="phoras"> Por Hora Técnica dos Profissionais Envolvidos</label>
              <div class="inline">
                <label class="inline"><input type="radio" name="calc" value="escopo"> Valor fechado por escopo — Estimativa</label>
                <input id="preco_escopo" type="number" min="0" step="50" placeholder="Informe o preço fechado (R$)" class="hide">
              </div>
              <div id="escopo_msg" class="escopo-note">
                <strong>Escopo fechado selecionado.</strong> Informe o preço desejado do projeto no campo acima. Este modo não usa CUB, LOD ou perfis — é um valor único acordado com o cliente.
              </div>
            </div>
          </div>
        </section>

        <section class="card" data-section="perfil">
          <div class="hd">
            <h2>3. Defina o Perfil dos Profissionais</h2>
            <button class="toggle" data-toggle>Recolher</button>
          </div>
          <div class="bd">
            <div class="hint" style="margin-bottom:10px">Informe quantos profissionais atuarão em cada perfil e a distribuição de horas.</div>
            <div class="form-grid">
              <div>
                <label>Engenheiro Júnior (R$ 85/h)</label>
                <input id="qtd_eng_jr" type="number" min="0" step="1" value="0">
              </div>
              <div>
                <label>Engenheiro Pleno (R$ 145/h)</label>
                <input id="qtd_eng_pl" type="number" min="0" step="1" value="0">
              </div>
              <div>
                <label>Engenheiro Sênior (R$ 210/h)</label>
                <input id="qtd_eng_sr" type="number" min="0" step="1" value="0">
              </div>
              <div>
                <label>Arquiteto Júnior (R$ 75/h)</label>
                <input id="qtd_arq_jr" type="number" min="0" step="1" value="0">
              </div>
              <div>
                <label>Arquiteto Pleno (R$ 125/h)</label>
                <input id="qtd_arq_pl" type="number" min="0" step="1" value="0">
              </div>
              <div>
                <label>Arquiteto Sênior (R$ 190/h)</label>
                <input id="qtd_arq_sr" type="number" min="0" step="1" value="0">
              </div>
            </div>

            <hr style="border:none;border-top:1px dashed var(--line);margin:14px 0">

            <div class="form-grid">
              <div>
                <label>Horas totais estimadas do projeto (todas as disciplinas)</label>
                <input id="horas_totais" type="number" min="0" step="10" value="240">
              </div>
              <div></div>
              <div>
                <label>Percentual Júnior (%)</label>
                <input id="pct_jr" type="number" min="0" max="100" step="1" value="20">
              </div>
              <div>
                <label>Percentual Pleno (%)</label>
                <input id="pct_pl" type="number" min="0" max="100" step="1" value="40">
              </div>
              <div>
                <label>Percentual Sênior (%)</label>
                <input id="pct_sr" type="number" min="0" max="100" step="1" value="40">
              </div>
              <div>
                <div class="hint" id="total_pct_hint">Total: 100%</div>
              </div>
            </div>
          </div>
        </section>

        <section class="card" data-section="base">
          <div class="hd">
            <h2>4. Base de Cálculo Referencial</h2>
            <button class="toggle" data-toggle>Recolher</button>
          </div>
          <div class="bd">
            <div class="actions" id="bases" style="margin-bottom:10px">
              <span class="pill" data-base="PA" data-cub="2164.98">Sinduscon-PA (Norte)</span>
              <span class="pill" data-base="PI" data-cub="1980.00">Sinduscon-PI (Nordeste)</span>
              <span class="pill" data-base="SP" data-cub="3390.00">Sinduscon-SP (Sudeste)</span>
              <span class="pill" data-base="PR" data-cub="2850.00">Sinduscon-PR (Sul)</span>
              <span class="pill" data-base="GO" data-cub="2560.00">Sinduscon-GO (Centro-Oeste)</span>
            </div>
            <div class="hint">Nota: Para m², selecione uma base Sinduscon.</div>
          </div>
        </section>
      </main>

      <aside>
        <section class="card right">
          <div class="hd"><h2>Resumo</h2></div>
          <div class="bd">
            <ul class="summary" id="resumo">
              <li><span>Tipo</span><strong id="r_tipo">—</strong></li>
              <li><span>Área</span><strong id="r_area">—</strong></li>
              <li><span>Complexidade</span><strong id="r_complex">—</strong></li>
              <li><span>LOD</span><strong id="r_lod">—</strong></li>
              <li><span>Modelo</span><strong id="r_calc">m²</strong></li>
              <li><span>Base</span><strong id="r_base">—</strong></li>
            </ul>
          </div>
        </section>

        <section class="card right">
          <div class="hd"><h2>Resultado</h2></div>
          <div class="bd">
            <div style="font-size:28px;font-weight:900" id="resultado">R$ —</div>
            <div class="hint" id="observacoes">Clique em “Simular Custo” para ver detalhes.</div>

            <div class="result-details" id="detalhes">
              <div class="range-box" id="box-faixa">
                <div class="k">Faixa Estimada</div>
                <div class="v" id="faixa">R$ — a R$ —</div>
              </div>
              <div class="range-box" id="box-sugerido">
                <div class="k">Valor Sugerido (média)</div>
                <div class="v" id="sugerido">R$ —</div>
              </div>

              <div style="margin-top:8px;font-weight:800">Fórmula utilizada</div>
              <div class="mono" id="formula">—</div>

              <div style="margin-top:8px;font-weight:800">Passos do cálculo</div>
              <ol class="steps" id="passos"></ol>

              <div style="margin-top:8px;font-weight:800">Observações sobre o Cálculo</div>
              <ul class="obs" id="obs"></ul>
            </div>

            <div style="height:8px"></div>
            <button class="btn primary" id="btnSimular">Simular Custo</button>
            <div style="height:8px"></div>
            <button class="btn ghost" id="btnExportar">Exportar PDF/Planilha</button>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    const KEY="sippbim:v9";
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    $$('[data-toggle]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const card = btn.closest('.card');
        card.classList.toggle('collapsed');
        btn.textContent = card.classList.contains('collapsed') ? 'Expandir' : 'Recolher';
      });
    });

    const map = {
      tipo: $('#tipo'),
      area: $('#area'),
      complex: $('#complex'),
      lod: $('#lod'),
      calc: ()=>document.querySelector('input[name=\"calc\"]:checked')?.value || 'm2',
      r_tipo: $('#r_tipo'), r_area: $('#r_area'), r_complex: $('#r_complex'), r_lod: $('#r_lod'), r_calc: $('#r_calc'),
      r_base: $('#r_base')
    };

    const basesEl = $('#bases');
    let base = { sigla: null, cub: null };
    basesEl.addEventListener('click', (e)=>{
      const p = e.target.closest('.pill'); if(!p) return;
      $$('.pill', basesEl).forEach(x=>x.classList.remove('selected'));
      p.classList.add('selected');
      base.sigla = p.dataset.base;
      base.cub = parseFloat(p.dataset.cub);
      map.r_base.textContent = `${p.textContent.trim()} — CUB R$ ${base.cub.toLocaleString('pt-BR', {minimumFractionDigits:2})}/m²`;
      save();
    });

    function applyCalcModeUI(){
      const mode = map.calc();
      const isM2 = mode==='m2';
      const isPH = mode==='phoras';
      const perfilCard = document.querySelector('[data-section=\"perfil\"]');
      const baseCard = document.querySelector('[data-section=\"base\"]');
      const note = document.getElementById('m2_note');

      if(note){ note.style.display = isM2 ? 'block' : 'none'; }

      if(isM2){
        perfilCard.classList.add('collapsed'); perfilCard.classList.add('locked');
        baseCard.classList.remove('locked'); baseCard.classList.remove('collapsed'); // EXPANDE item 4
      } else if(isPH){
        perfilCard.classList.remove('locked'); perfilCard.classList.remove('collapsed'); // abre item 3
        baseCard.classList.add('collapsed'); baseCard.classList.add('locked');            // trava item 4
      } else { // escopo
        perfilCard.classList.remove('locked');
        baseCard.classList.remove('locked');
      }

      // Atualiza rótulo dos botões
      $$('[data-section]').forEach(sec=>{
        const btn = sec.querySelector('[data-toggle]');
        if(!btn) return;
        btn.textContent = sec.classList.contains('collapsed') ? 'Expandir' : 'Recolher';
      });
    }

    // Escopo input + mensagem toggle
    document.addEventListener('change', e=>{
      if(e.target.name==='calc'){
        const escopoAtivo = map.calc()==='escopo';
        $('#preco_escopo').classList.toggle('hide', !escopoAtivo);
        $('#escopo_msg').style.display = escopoAtivo ? 'block' : 'none';
        applyCalcModeUI();
      }
    });

    function updateResumo(){
      map.r_tipo.textContent = map.tipo.value;
      map.r_area.textContent = map.area.value ? `${map.area.value} m²` : '—';
      map.r_complex.textContent = map.complex.options[map.complex.selectedIndex].text;
      map.r_lod.textContent = map.lod.value;
      map.r_calc.textContent = map.calc().toUpperCase();
    }

    function save(){
      const state = {
        tipo: map.tipo.value, area: map.area.value, complex: map.complex.value, lod: map.lod.value,
        calc: map.calc(),
        qtds: {
          eng_jr: +$('#qtd_eng_jr').value, eng_pl: +$('#qtd_eng_pl').value, eng_sr: +$('#qtd_eng_sr').value,
          arq_jr: +$('#qtd_arq_jr').value, arq_pl: +$('#qtd_arq_pl').value, arq_sr: +$('#qtd_arq_sr').value
        },
        horas_totais: +$('#horas_totais').value,
        pcts: { jr:+$('#pct_jr').value, pl:+$('#pct_pl').value, sr:+$('#pct_sr').value },
        base,
        preco_escopo: +$('#preco_escopo').value || 0
      };
      localStorage.setItem(KEY, JSON.stringify(state));
    }
    function load(){
      const raw = localStorage.getItem(KEY); if(!raw) { applyCalcModeUI(); return; }
      const s = JSON.parse(raw);
      map.tipo.value = s.tipo ?? map.tipo.value;
      map.area.value = s.area ?? '';
      map.complex.value = s.complex ?? map.complex.value;
      map.lod.value = s.lod ?? map.lod.value;
      if(s.calc){ const el = document.querySelector(`input[name=\"calc\"][value=\"${s.calc}\"]`); if(el) el.checked = true; }
      $('#qtd_eng_jr').value = s.qtds?.eng_jr ?? 0;
      $('#qtd_eng_pl').value = s.qtds?.eng_pl ?? 0;
      $('#qtd_eng_sr').value = s.qtds?.eng_sr ?? 0;
      $('#qtd_arq_jr').value = s.qtds?.arq_jr ?? 0;
      $('#qtd_arq_pl').value = s.qtds?.arq_pl ?? 0;
      $('#qtd_arq_sr').value = s.qtds?.arq_sr ?? 0;
      $('#horas_totais').value = s.horas_totais ?? 240;
      $('#pct_jr').value = s.pcts?.jr ?? 20;
      $('#pct_pl').value = s.pcts?.pl ?? 40;
      $('#pct_sr').value = s.pcts?.sr ?? 40;
      if(s.base?.sigla){
        const p = $(`.pill[data-base=\"${s.base.sigla}\"]`, basesEl);
        if(p){ p.classList.add('selected'); }
        base = s.base;
        if(base.cub){
          map.r_base.textContent = `${$(`.pill[data-base=\"${s.base.sigla}\"]`).textContent.trim()} — CUB R$ ${base.cub.toLocaleString('pt-BR', {minimumFractionDigits:2})}/m²`;
        }
      }
      if(s.preco_escopo){ $('#preco_escopo').value = s.preco_escopo; }
      const escopoAtivo = map.calc()==='escopo';
      $('#preco_escopo').classList.toggle('hide', !escopoAtivo);
      $('#escopo_msg').style.display = escopoAtivo ? 'block' : 'none';
      updateResumo();
      applyCalcModeUI();
    }

    // Parâmetros
    const PERC_FAIXA = {
      'Arquitetônico': [0.015, 0.020],
      'Estrutural':    [0.012, 0.018],
      'Instalações':   [0.012, 0.018],
      'Consultoria':   [0.008, 0.012]
    };
    const MULT_COMPLEX = { baixa:0.90, media:1.00, alta:1.20 };
    const MULT_LOD = { 'LOD 200':0.90, 'LOD 300':1.00, 'LOD 350':1.10, 'LOD 400':1.20 };

    function showDetails(show){ $('#detalhes').style.display = show ? 'block' : 'none'; }
    function showRange(show){
      $('#box-faixa').classList.toggle('hide', !show);
      $('#box-sugerido').classList.toggle('hide', !show);
    }

    function recalculate(){
      const modelo = map.calc();
      const area = parseFloat(map.area.value||0);
      let valor = 0;
      showDetails(true);

      if(modelo==='m2'){
        const cub = parseFloat(base.cub || 0);
        if(!cub || !area){
          $('#resultado').textContent = 'R$ —';
          $('#observacoes').textContent = 'Informe a área e selecione a base Sinduscon.';
          showRange(false);
          $('#formula').textContent = '—';
          $('#passos').innerHTML = ''; $('#obs').innerHTML = '';
          return;
        }
        const [pmin, pmax] = PERC_FAIXA[map.tipo.value] || [0.015, 0.02];
        const mC = MULT_COMPLEX[map.complex.value] || 1.0;
        const mL = MULT_LOD[map.lod.value] || 1.0;

        const vmin = area * cub * pmin * mC * mL;
        const vmax = area * cub * pmax * mC * mL;
        const vsug = (vmin + vmax) / 2;
        valor = vsug;

        $('#resultado').textContent = `R$ ${valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        $('#observacoes').textContent = `Base: R$ ${cub.toLocaleString('pt-BR',{minimumFractionDigits:2})}/m² × Área informada. Fatores aplicados.`;
        $('#faixa').textContent = `R$ ${vmin.toLocaleString('pt-BR',{minimumFractionDigits:2})} - R$ ${vmax.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        $('#sugerido').textContent = `R$ ${vsug.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        showRange(true);

        $('#formula').textContent = 'Valor Total = Área × Valor CUB × Percentual Projeto × Multiplicador Complexidade × Multiplicador LOD';
        const passos = [
          `Valor CUB base (selecionado): R$ ${cub.toLocaleString('pt-BR',{minimumFractionDigits:2})}/m²`,
          `Percentual para projeto ${map.tipo.value}: ${(pmin*100).toFixed(1)}% a ${(pmax*100).toFixed(1)}% do CUB`,
          `Aplicação dos multiplicadores de Complexidade (${mC.toFixed(2)}) e LOD (${mL.toFixed(2)})`,
          `Valor mínimo: ${area}m² × R$ ${cub.toLocaleString('pt-BR',{minimumFractionDigits:2})}/m² × ${(pmin*100).toFixed(1)}% × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${vmin.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Valor máximo: ${area}m² × R$ ${cub.toLocaleString('pt-BR',{minimumFractionDigits:2})}/m² × ${(pmax*100).toFixed(1)}% × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${vmax.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Valor sugerido (média): R$ ${vsug.toLocaleString('pt-BR',{minimumFractionDigits:2})}`
        ];
        $('#passos').innerHTML = passos.map(x=>`<li>${x}</li>`).join('');
        const obsList = [
          `Base de Referência: ${map.r_base.textContent || '—'}`,
          `Tipo de Projeto Principal: ${map.tipo.value}`,
          `Complexidade: ${map.complex.options[map.complex.selectedIndex].text} (multiplicador: ${mC.toFixed(2)})`,
          `LOD: ${map.lod.value} (multiplicador: ${mL.toFixed(2)})`,
          `Área do Projeto: ${area} m²`,
          `Nota: Para cálculo por m², horas de profissionais não entram diretamente.`
        ];
        $('#obs').innerHTML = obsList.map(x=>`<li>${x}</li>`).join('');

      } else if(modelo==='phoras'){
        const totalHoras = +$('#horas_totais').value || 0;
        const pj = +$('#pct_jr').value || 0, pp = +$('#pct_pl').value || 0, ps = +$('#pct_sr').value || 0;
        const somaPct = pj+pp+ps;
        const hint = $('#total_pct_hint');
        hint.textContent = `Total: ${somaPct}%`;
        hint.style.color = (somaPct===100)? '#0FB268' : '#b91c1c';

        const horas = {
          jr: totalHoras * (pj/100),
          pl: totalHoras * (pp/100),
          sr: totalHoras * (ps/100),
        };

        const qtds = {
          eng_jr:+$('#qtd_eng_jr').value, eng_pl:+$('#qtd_eng_pl').value, eng_sr:+$('#qtd_eng_sr').value,
          arq_jr:+$('#qtd_arq_jr').value, arq_pl:+$('#qtd_arq_pl').value, arq_sr:+$('#qtd_arq_sr').value
        };
        const tarifa = { eng_jr:85, eng_pl:145, eng_sr:210, arq_jr:75, arq_pl:125, arq_sr:190 };

        const mC = MULT_COMPLEX[map.complex.value] || 1.0;
        const mL = MULT_LOD[map.lod.value] || 1.0;

        const sub = {
          eng_jr: qtds.eng_jr * horas.jr * tarifa.eng_jr * mC * mL,
          eng_pl: qtds.eng_pl * horas.pl * tarifa.eng_pl * mC * mL,
          eng_sr: qtds.eng_sr * horas.sr * tarifa.eng_sr * mC * mL,
          arq_jr: qtds.arq_jr * horas.jr * tarifa.arq_jr * mC * mL,
          arq_pl: qtds.arq_pl * horas.pl * tarifa.arq_pl * mC * mL,
          arq_sr: qtds.arq_sr * horas.sr * tarifa.arq_sr * mC * mL,
        };
        const total = Object.values(sub).reduce((a,b)=>a+b,0);
        valor = total;

        $('#resultado').textContent = `R$ ${valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        $('#observacoes').textContent = `Distribuição aplicada: Júnior ${pj}%, Pleno ${pp}%, Sênior ${ps}% sobre ${totalHoras}h totais.`;
        const vmin = valor*0.75, vmax = valor*1.25;
        $('#faixa').textContent = `R$ ${vmin.toLocaleString('pt-BR',{minimumFractionDigits:2})} - R$ ${vmax.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        $('#sugerido').textContent = `R$ ${valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        showRange(true);

        $('#formula').textContent = 'Valor Total = Σ (Qtd_prof_nível × Horas_nível × Tarifa_nível_disciplina × Multiplicador_Complexidade × Multiplicador_LOD)';
        const passos = [
          `Horas por nível: Júnior ${horas.jr.toFixed(1)}h, Pleno ${horas.pl.toFixed(1)}h, Sênior ${horas.sr.toFixed(1)}h (de ${totalHoras}h). Multiplicadores aplicados: Complexidade ${mC.toFixed(2)}, LOD ${mL.toFixed(2)}.`,
          `Eng. Júnior: ${qtds.eng_jr} × ${horas.jr.toFixed(1)}h × R$ ${tarifa.eng_jr}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.eng_jr.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Eng. Pleno: ${qtds.eng_pl} × ${horas.pl.toFixed(1)}h × R$ ${tarifa.eng_pl}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.eng_pl.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Eng. Sênior: ${qtds.eng_sr} × ${horas.sr.toFixed(1)}h × R$ ${tarifa.eng_sr}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.eng_sr.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Arq. Júnior: ${qtds.arq_jr} × ${horas.jr.toFixed(1)}h × R$ ${tarifa.arq_jr}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.arq_jr.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Arq. Pleno: ${qtds.arq_pl} × ${horas.pl.toFixed(1)}h × R$ ${tarifa.arq_pl}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.arq_pl.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Arq. Sênior: ${qtds.arq_sr} × ${horas.sr.toFixed(1)}h × R$ ${tarifa.arq_sr}/h × ${mC.toFixed(2)} × ${mL.toFixed(2)} = R$ ${sub.arq_sr.toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
          `Total = R$ ${valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`
        ];
        $('#passos').innerHTML = passos.map(x=>`<li>${x}</li>`).join('');
        $('#obs').innerHTML = [
          'Multiplicadores aplicados conforme Complexidade e LOD.',
          'A soma dos percentuais deve ser 100%.',
          'Ajuste horas totais, quantidades e tarifas conforme o escopo real.',
          'Some BDI/impostos e despesas reembolsáveis segundo sua política.'
        ].map(x=>`<li>${x}</li>`).join('');

      } else if(modelo==='escopo'){
        const preco = +($('#preco_escopo').value||0);
        if(!preco){
          $('#resultado').textContent = 'R$ —';
          $('#observacoes').textContent = 'Informe o preço fechado desejado no campo ao lado.';
          $('#formula').textContent = '—';
          $('#passos').innerHTML = ''; $('#obs').innerHTML = ''; showRange(false); return;
        }
        const valor = preco;
        $('#resultado').textContent = `R$ ${valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
        $('#observacoes').textContent = `Preço fechado informado pelo usuário.`;
        showRange(false);

        $('#formula').textContent = 'Valor Total = Preço Fechado Informado';
        $('#passos').innerHTML = [
          'Definição de marcos e entregáveis do escopo',
          'Composição de custos diretos/indiretos e margem acordada'
        ].map(x=>`<li>${x}</li>`).join('');
        $('#obs').innerHTML = [
          'Prever cláusulas de revisão de escopo e reajuste.',
          'Cronograma e condições de pagamento impactam o preço final.'
        ].map(x=>`<li>${x}</li>`).join('');
      }
    }

    ['change','input'].forEach(evt=>{
      document.addEventListener(evt, e=>{
        if(e.target.closest('input,select,textarea')){ updateResumo(); save();
          if(e.target.id==='pct_jr' || e.target.id==='pct_pl' || e.target.id==='pct_sr'){
            const soma = (+$('#pct_jr').value||0)+(+$('#pct_pl').value||0)+(+$('#pct_sr').value||0);
            const hint = $('#total_pct_hint'); hint.textContent = `Total: ${soma}%`; hint.style.color = (soma===100)? '#0FB268' : '#b91c1c';
          }
        }
      });
    });
    /* === EXPORTAÇÃO PARA PDF (V9) === */
function exportarParaPDF () {
  // 1) Garantir que há resultado simulado (usa o card/summary da direita)
  const resumo = document.querySelector('aside .summary, aside .card.right');
  if (!resumo || !resumo.innerText.trim()) {
    alert('Por favor, realize uma simulação antes de exportar o relatório.');
    return;
  }

  // 2) Coletar dados básicos dos inputs (ajuste os IDs se forem diferentes)
  const tipoProjetoEl   = document.querySelector('#tipo, select[name="tipo"]');
  const areaEl          = document.querySelector('#area, input[name="area"]');
  const complexEl       = document.querySelector('#complexidade, select[name="complexidade"]');
  const lodEl           = document.querySelector('#lod, select[name="lod"]');
  const localidadeEl    = document.querySelector('#localidade, input[name="localidade"]');
  const baseCalcEl      = document.querySelector('#base_calc, select[name="base_calc"]');

  // modelo (M2 / hora / hora-perfil / escopo)
  const modeloSelecionado =
    (document.querySelector('input[name="modelo"]:checked')?.value) || 'm2';

  // 3) Montar conteúdo do PDF (cabeçalho + dados + resumo + explicação)
  const conteudoPDF = document.createElement('div');
  conteudoPDF.className = 'pdf-content';

  const estilosPDF = document.createElement('style');
  estilosPDF.textContent = `
    .pdf-content{font-family:Arial,sans-serif;color:#333;line-height:1.5;}
    .pdf-header{text-align:center;margin-bottom:20px;}
    .pdf-header h1{color:#0077b6;font-size:24px;margin-bottom:10px;}
    .pdf-section{margin-bottom:20px;}
    .pdf-section h2{color:#0077b6;font-size:18px;border-bottom:1px solid #0077b6;padding-bottom:5px;margin-bottom:10px;}
    .pdf-resultado{padding:10px;margin:10px 0;border-left:4px solid #0077b6;background-color:#f0f8ff;}
    .pdf-footer{margin-top:30px;text-align:center;font-size:12px;color:#666;}
  `;
  conteudoPDF.appendChild(estilosPDF);

  // Cabeçalho
  const h = document.createElement('div');
  h.className = 'pdf-header';
  h.innerHTML = `<h1>Simulador de Preços de Projetos BIM — SIPP BIM</h1>`;
  conteudoPDF.appendChild(h);

// ---------- util: pegar pares "rótulo: valor" do Resumo ----------
function pickFromResumo(label){
  const resumo = document.querySelector('aside .summary, aside .card.right');
  if(!resumo) return '';
  // tenta li/rows com "rótulo valor"
  const items = resumo.querySelectorAll('li, .row, .item, p, div');
  for(const el of items){
    const t = el.textContent.replace(/\s+/g,' ').trim();
    if(new RegExp(`^${label}\\b`, 'i').test(t)){
      // tenta pegar texto após “:”
      const m = t.split(':').slice(1).join(':').trim();
      if(m) return m;
      // ou um <b>/<span> dentro
      const val = el.querySelector('b, strong, span, .value');
      if(val) return val.textContent.trim();
      return t;
    }
  }
  return '';
}

// ---------- DADOS DO PROJETO ----------
const dados = document.createElement('div'); 
dados.className = 'pdf-section';

const tipoProjeto   = pickFromResumo('Tipo')        || (document.querySelector('#tipo, select[name="tipo"]')?.selectedOptions?.[0]?.text || '-');
const areaProjeto   = pickFromResumo('Área')        || (document.querySelector('#area, input[name="area"]')?.value ? `${document.querySelector('#area, input[name="area"]').value} m²` : '-');
const complexidade  = pickFromResumo('Complexidade')|| (document.querySelector('#complexidade, select[name="complexidade"]')?.value || '-');
const lod           = pickFromResumo('LOD')         || (document.querySelector('#lod, select[name="lod"]')?.value || '-');
const modelo        = pickFromResumo('Modelo')      || (document.querySelector('input[name="modelo"]:checked')?.value || '-');
const baseCalculo   = pickFromResumo('Base')        || (document.querySelector('#base_calc, select[name="base_calc"]')?.selectedOptions?.[0]?.text || '-');
const localidade    = document.querySelector('#localidade, input[name="localidade"]')?.value || pickFromResumo('Localidade') || 'Não informado';

dados.innerHTML = `
  <h2>Dados do Projeto</h2>
  <p><strong>Tipo de Projeto:</strong> ${tipoProjeto}</p>
  <p><strong>Área:</strong> ${areaProjeto}</p>
  <p><strong>Complexidade:</strong> ${complexidade}</p>
  <p><strong>LOD:</strong> ${lod}</p>
  <p><strong>Base de Cálculo:</strong> ${baseCalculo}</p>
  <p><strong>Tipo de Cálculo:</strong> ${
    /m2|M2|metro/i.test(modelo) ? 'Por metro quadrado' :
    /hora-perfil/i.test(modelo)  ? 'Por Hora Técnica dos Profissionais Envolvidos' :
    /hora/i.test(modelo)         ? 'Por hora técnica' : 
                                   (modelo || '—')
  }</p>
  <p><strong>Localidade:</strong> ${localidade}</p>
`;
conteudoPDF.appendChild(dados);

// ---------- RESULTADOS ----------
const resultados = document.createElement('div'); 
resultados.className = 'pdf-section';

const faixaEstimada = pickFromResumo('Faixa Estimada') || document.querySelector('[data-id="faixa"], .faixa, .range')?.textContent?.trim() || '-';
const valorSugerido = pickFromResumo('Valor Sugerido') || document.querySelector('[data-id="sugerido"], .sugerido, .suggested')?.textContent?.trim() || '-';

resultados.innerHTML = `
  <h2>Resultados da Simulação</h2>
  <div class="pdf-resultado">
    <p><strong>Faixa Estimada:</strong> ${faixaEstimada}</p>
    <p><strong>Valor Sugerido:</strong> ${valorSugerido}</p>
  </div>
`;
conteudoPDF.appendChild(resultados);

// ---------- FÓRMULA / PASSOS / OBSERVAÇÕES (clona bloco da V9) ----------
function cloneExplainCard(){
  // tenta achar um card com títulos conhecidos
  const candidates = Array.from(document.querySelectorAll('.card, section, article, .explain, #explicacao'))
    .filter(c=>{
      const txt = c.textContent.toLowerCase();
      return txt.includes('fórmula') && (txt.includes('passos') || txt.includes('observa') || txt.includes('cálculo'));
    });
  return candidates[0] || null;
}
const explainCard = cloneExplainCard();
if(explainCard){
  const expWrap = document.createElement('div'); 
  expWrap.className = 'pdf-section';
  expWrap.innerHTML = `<h2>Explicação Detalhada do Cálculo</h2>${explainCard.innerHTML}`;
  conteudoPDF.appendChild(expWrap);
}

  // Rodapé
  const f = document.createElement('div'); f.className='pdf-footer';
  const dataHora = new Date().toLocaleString('pt-BR');
  f.innerHTML = `
    <p>Relatório gerado em: ${dataHora}</p>
    <p>© SIPP BIM - Simulador de Precificação de Projetos BIM</p>
    <p>Desenvolvido por: RBIM CONSULTORIA — Direitos Reservados</p>
  `;
  conteudoPDF.appendChild(f);

  // 4) Gerar HTML e imprimir (usa janela de impressão para “Salvar como PDF”)
  const htmlContent = conteudoPDF.outerHTML;
  const blob = new Blob([`
    <!doctype html><html><head><meta charset="utf-8">
      <title>Simulação de Custos BIM</title>
      <meta name="viewport" content="width=device-width,initial-scale=1">
    </head><body>${htmlContent}</body></html>
  `], { type: 'text/html' });

  const url = URL.createObjectURL(blob);
  const w = window.open(url, '_blank');
  w.onload = () => { w.print(); URL.revokeObjectURL(url); };
}
/* === FIM EXPORTAÇÃO PARA PDF (V9) === */

    $('#btnSimular').addEventListener('click', recalculate);
    $('#btnExportar').addEventListener('click', exportarParaPDF);

    // init
    (function init(){
      load(); updateResumo();
      const somaInit = (+$('#pct_jr').value||0)+(+$('#pct_pl').value||0)+(+$('#pct_sr').value||0);
      const hintInit = $('#total_pct_hint'); hintInit.textContent = `Total: ${somaInit}%`; hintInit.style.color = (somaInit===100)? '#0FB268' : '#b91c1c';
      applyCalcModeUI();
    })();
  </script>

  <!-- AUTH GUARD: Verificacao de sessao e status -->
  <script>
  (async function authGuard() {
    const SUPABASE_URL = 'https://extggehxevmwknixuhpn.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_0F-m0AEgpGOlWHPCGYJuiQ_XWf7Hdm9';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) { window.location.replace('login.html'); return; }
      const { data: profile, error: profileError } = await sb
        .from('profiles').select('status').eq('id', session.user.id).single();
      if (profileError || !profile) {
        await sb.auth.signOut();
        window.location.replace('pendente.html');
        return;
      }
      if (profile.status !== 'ativo') {
        await sb.auth.signOut();
        window.location.replace('pendente.html');
        return;
      }
      document.documentElement.style.visibility = 'visible';
    } catch (err) {
      console.error('Auth guard error:', err);
      window.location.replace('login.html');
    }
  })();
  </script>
  <!-- FIM AUTH GUARD -->
<script>
  // Usa o MESMO supabase já criado no Auth Guard
  const btn = document.getElementById("logoutBtn");
  if (btn) {
    btn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.replace("login.html");
    });
  }
</script>

</body>
</html>

